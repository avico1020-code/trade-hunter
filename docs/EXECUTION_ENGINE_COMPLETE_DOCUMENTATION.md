# ×“×•×— ××¤×•×¨×˜: ××¢×¨×›×ª ×‘×™×¦×•×¢ ××¡×—×¨ (Execution Engine System)

**×ª××¨×™×š ×¢×“×›×•×Ÿ ××—×¨×•×Ÿ:** ×“×¦××‘×¨ 2024  
**×’×¨×¡×”:** 1.0  
**×¡×˜×˜×•×¡:** Production Ready (×—×œ×§ ××”×ª×›×•× ×•×ª ×‘×ª×›× ×•×Ÿ)

---

## ğŸ“‹ ×ª×•×›×Ÿ ×¢× ×™×™× ×™×

1. [×¡×§×™×¨×” ×›×œ×œ×™×ª](#×¡×§×™×¨×”-×›×œ×œ×™×ª)
2. [××¨×›×™×˜×§×˜×•×¨×” ×›×œ×œ×™×ª](#××¨×›×™×˜×§×˜×•×¨×”-×›×œ×œ×™×ª)
3. [×¨×›×™×‘×™× ×¢×™×§×¨×™×™×](#×¨×›×™×‘×™×-×¢×™×§×¨×™×™×)
4. [×ª×”×œ×™×š ×‘×™×¦×•×¢ ×¢×¡×§×”](#×ª×”×œ×™×š-×‘×™×¦×•×¢-×¢×¡×§×”)
5. [× ×™×”×•×œ ×¤×•×–×™×¦×™×•×ª](#× ×™×”×•×œ-×¤×•×–×™×¦×™×•×ª)
6. [× ×™×”×•×œ ×¡×™×›×•× ×™×](#× ×™×”×•×œ-×¡×™×›×•× ×™×)
7. [×ª×›×•× ×•×ª ××ª×§×“××•×ª](#×ª×›×•× ×•×ª-××ª×§×“××•×ª)
8. [××™× ×˜×’×¨×¦×™×•×ª](#××™× ×˜×’×¨×¦×™×•×ª)
9. [××¦×‘ × ×•×›×—×™ ×•×ª×›× ×•×Ÿ ×¢×ª×™×“×™](#××¦×‘-× ×•×›×—×™-×•×ª×›× ×•×Ÿ-×¢×ª×™×“×™)
10. [×“×•×’×××•×ª ×©×™××•×©](#×“×•×’×××•×ª-×©×™××•×©)

---

## ğŸ¯ ×¡×§×™×¨×” ×›×œ×œ×™×ª

### ××˜×¨×ª ×”××¢×¨×›×ª

**Execution Engine** ×”×™× ×”×©×›×‘×” ×”××—×¨×•× ×” ×‘××¢×¨×›×ª ×”××¡×—×¨ ×”××œ×’×•×¨×™×ª××™×ª, ×”××—×¨××™×ª ×¢×œ:
1. **×‘×™×¦×•×¢ ×¢×¡×§××•×ª ×‘×¤×•×¢×œ** - ×§×‘×œ×ª PatternFoundEvent ××”×¡×•×¨×§ ×•×‘×™×¦×•×¢ ×”×¤×§×•×“×•×ª
2. **× ×™×”×•×œ ×¤×•×–×™×¦×™×•×ª** - ××¢×§×‘ ××—×¨×™ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª, ×¢×“×›×•×Ÿ ××—×™×¨×™×, × ×™×”×•×œ ×¡×˜×•×¤×™×
3. **× ×™×”×•×œ ×¡×™×›×•× ×™×** - ×”×’×‘×œ×•×ª ×—×©×™×¤×”, ××’×‘×œ×•×ª ×”×¤×¡×“, × ×™×”×•×œ ×’×•×“×œ ×¤×•×–×™×¦×™×•×ª
4. **××•×¤×˜×™××™×–×¦×™×”** - Opportunity Reallocation, Trailing Stops, Time-based Exits

### ××™×§×•× ×‘××¢×¨×›×ª ×”×›×•×œ×œ×ª

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    ××¢×¨×›×ª ×”××¡×—×¨ ×”××œ×’×•×¨×™×ª××™×ª                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                     â”‚                     â”‚
        â–¼                     â–¼                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Master       â”‚â”€â”€â”€â–¶â”‚ Trade Pattern    â”‚â”€â”€â”€â–¶â”‚ Execution    â”‚â”€â”€â”€â–¶ IBKR
â”‚ Scoring      â”‚    â”‚ Scanner          â”‚    â”‚ Engine       â”‚     Broker
â”‚ System       â”‚    â”‚                  â”‚    â”‚              â”‚
â”‚              â”‚    â”‚ â€¢ Pattern        â”‚    â”‚ â€¢ Trade      â”‚
â”‚ â€¢ Technical  â”‚    â”‚   Detection      â”‚    â”‚   Execution  â”‚
â”‚ â€¢ News       â”‚    â”‚ â€¢ Real-time      â”‚    â”‚ â€¢ Position   â”‚
â”‚ â€¢ Macro      â”‚    â”‚   Scanning       â”‚    â”‚   Management â”‚
â”‚ â€¢ Sector     â”‚    â”‚ â€¢ Direction      â”‚    â”‚ â€¢ Risk Mgmt  â”‚
â”‚ â€¢ Options    â”‚    â”‚   Filtering      â”‚    â”‚ â€¢ IBKR API   â”‚
â”‚ â€¢ Micro      â”‚    â”‚                  â”‚    â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ—ï¸ ××¨×›×™×˜×§×˜×•×¨×” ×›×œ×œ×™×ª

### ×¢×§×¨×•× ×•×ª ×¢×™×¦×•×‘

1. **Event-Driven** - ××’×™×‘ ×œ××™×¨×•×¢×™× ××”×¡×•×¨×§ ×•×œ× ×™×•×–× ×‘×¢×¦××•
2. **State Management** - × ×™×”×•×œ ××œ× ×©×œ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª ×•×¡×’×•×¨×•×ª
3. **Risk-First** - ×›×œ ×”×—×œ×˜×” ×¢×•×‘×¨×ª ×“×¨×š ×‘×“×™×§×•×ª ×¡×™×›×•×Ÿ
4. **Mode-Aware** - ×ª××™×›×” ×‘-LIVE/DEMO/BACKTEST
5. **Thread-Safe** - ×©×™××•×© ×‘-locks ×œ×× ×™×¢×ª race conditions

### ××‘× ×” ×”×§×‘×¦×™×

```
lib/
â””â”€â”€ execution/
    â””â”€â”€ execution-engine.ts    # ××—×œ×§×ª Execution Engine ×”×¨××©×™×ª
```

---

## ğŸ”§ ×¨×›×™×‘×™× ×¢×™×§×¨×™×™×

### 1. ExecutionEngine Class

**××™×§×•×:** `lib/execution/execution-engine.ts`

**×ª×¤×§×™×“×™×:**
- ×§×‘×œ×ª PatternFoundEvent ××”×¡×•×¨×§
- ×—×™×©×•×‘ ×’×•×“×œ ×¤×•×–×™×¦×™×” ×œ×¤×™ R-Multiple
- ×‘×™×¦×•×¢ ×¤×§×•×“×•×ª ×‘×‘×¨×•×§×¨ (IBKR)
- × ×™×”×•×œ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª
- ××¢×§×‘ ××—×¨×™ ××—×™×¨×™× ×•×¢×“×›×•×Ÿ ×¡×˜×•×¤×™×
- ×¡×’×™×¨×ª ×¤×•×–×™×¦×™×•×ª (stop-loss, take-profit, forced)

**××‘× ×” ×”×§×œ××¡:**

```typescript
export class ExecutionEngine {
  private openPositions: OpenPosition[] = [];
  private closedTrades: ClosedTrade[] = [];
  private processingLock = false;
  
  // Risk tracking
  private dailyPnL = 0;
  private accountPeak = 0;
  private consecutiveFailures = 0;
  private circuitBreakerOpen = false;
  
  constructor(
    private config: ExecutionEngineConfig,
    private ibkrClient: IBKRClient | null,
    private strategyMap: Map<string, IPatternStrategy>
  )
}
```

### 2. ExecutionEngineConfig Interface

**×ª×¤×§×™×“:** ×”×’×“×¨×ª ×›×œ ×”×¤×¨××˜×¨×™× ×”× ×™×ª× ×™× ×œ×”×’×“×¨×”

**××‘× ×”:**

```typescript
export interface ExecutionEngineConfig {
  // Account & Exposure
  totalAccountValue: number;           // ×©×•×•×™ ×—×©×‘×•×Ÿ ×›×•×œ×œ ($)
  maxExposurePct: number;              // ××—×•×– ×—×©×™×¤×” ××§×¡×™××œ×™ (95%)
  maxConcurrentTrades: number;         // ××¡×¤×¨ ××§×¡×™××œ×™ ×©×œ ×¢×¡×§××•×ª ×‘××§×‘×™×œ
  
  // Risk Management
  riskPerTradePct: number;             // ××—×•×– ×¡×™×›×•×Ÿ ×œ×¢×¡×§×” (1%)
  dailyLossLimit?: number;             // ××’×‘×œ×ª ×”×¤×¡×“ ×™×•××™ ($)
  maxDrawdownPct?: number;             // ××’×‘×œ×ª Drawdown (%)
  maxPositionSizePerSymbol?: number;   // ×’×•×“×œ ××§×¡×™××œ×™ ×œ×× ×™×” ($)
  
  // Execution Mode
  mode: "LIVE" | "DEMO" | "BACKTEST";
  
  // Time Management
  latestEntryTime: string;             // "15:30" - ×©×¢×” ××—×¨×•× ×” ×œ×›× ×™×¡×”
  forceExitTime: string;               // "15:45" - ×©×¢×” ×œ×¡×’×™×¨×” ×›×¤×•×™×”
  
  // Opportunity Reallocation
  relocationThresholdR: number;        // ×¡×£ R ×œ×”×—×œ×¤×ª ×¤×•×–×™×¦×™×” (2.0)
  
  // Circuit Breaker (Optional)
  circuitBreakerEnabled?: boolean;
  circuitBreakerFailureThreshold?: number;
  circuitBreakerCooldownMs?: number;
}
```

### 3. TradeSetup Interface

**×ª×¤×§×™×“:** ××•×‘×™×™×§×˜ ×”××ª××¨ ×¢×¡×§×” ××ª×•×›× × ×ª ×œ×¤× ×™ ×‘×™×¦×•×¢

**××‘× ×”:**

```typescript
export interface TradeSetup {
  symbol: string;
  strategyName: string;
  direction: "LONG" | "SHORT";
  
  entryPrice: number;
  stopLoss: number;
  
  riskPerShare: number;      // Entry - Stop Loss
  riskDollars: number;        // Total risk in dollars
  quantity: number;           // Number of shares
  
  masterScore: number;
  masterDirection: "LONG" | "SHORT";
  metadata: any;              // Additional strategy data
  
  createdAt: string;          // ISO timestamp
}
```

### 4. OpenPosition Interface

**×ª×¤×§×™×“:** ×¤×•×–×™×¦×™×” ×¤×ª×•×—×” ×¤×¢×™×œ×”

**××‘× ×”:**

```typescript
export interface OpenPosition {
  symbol: string;
  strategyName: string;
  direction: "LONG" | "SHORT";
  
  entryPrice: number;
  stopLoss: number;
  initialStopLoss: number;   // Original stop (before trailing)
  
  quantity: number;
  openedAt: string;
  
  riskPerShare: number;
  riskDollars: number;
  
  masterScore: number;
  masterDirection: "LONG" | "SHORT";
  
  lastPrice: number;         // Latest market price
  bestPrice: number;         // Best price achieved (for trailing)
  
  metadata: any;
}
```

### 5. ClosedTrade Interface

**×ª×¤×§×™×“:** ×¢×¡×§×” ×¡×’×•×¨×” (×”×™×¡×˜×•×¨×™×”)

**××‘× ×”:**

```typescript
export interface ClosedTrade {
  symbol: string;
  strategyName: string;
  direction: "LONG" | "SHORT";
  
  entryPrice: number;
  exitPrice: number;
  quantity: number;
  
  riskPerShare: number;
  riskDollars: number;
  
  pnl: number;               // Realized P&L in dollars
  rMultiple: number;         // P&L measured in R multiples
  
  openedAt: string;
  closedAt: string;
  
  masterScore: number;
  masterDirection: "LONG" | "SHORT";
  
  exitReason: ExitReason;    // "stop-loss" | "strategy-exit" | "relocation" | "force-close-end-of-day" | "manual"
  metadata: any;
}
```

### 6. IBKRClient Interface

**×ª×¤×§×™×“:** ×××©×§ ×œ×‘×™×¦×•×¢ ×¤×§×•×“×•×ª ×‘×‘×¨×•×§×¨

**××‘× ×”:**

```typescript
export interface IBKRClient {
  placeMarketOrder(
    symbol: string,
    quantity: number,
    side: "BUY" | "SELL"
  ): Promise<OrderExecutionResult>;
  
  // Optional methods for connection management
  isConnected?(): boolean;
  reconnect?(): Promise<void>;
}
```

---

## ğŸ”„ ×ª×”×œ×™×š ×‘×™×¦×•×¢ ×¢×¡×§×”

### ×©×œ×‘ 1: ×§×‘×œ×ª PatternFoundEvent

```
Trade Pattern Scanner
  â†“
PatternFoundEvent {
  symbol: "AAPL",
  strategyName: "DOUBLE_TOP",
  strategyDirection: "SHORT",
  patternState: {
    patternFound: true,
    entryPrice: 180.50,
    stopLoss: 185.00,
    metadata: {...}
  },
  master: {
    direction: "SHORT",
    masterScore: 7.5,
    moduleScores: {...}
  },
  detectedAt: "2024-12-15T10:30:00.000Z"
}
  â†“
ExecutionEngine.onPatternEvent(event)
```

### ×©×œ×‘ 2: ×‘×“×™×§×•×ª ××§×“×™××•×ª

```
1. âœ… ×‘×“×™×§×ª Circuit Breaker
   - ×× ×¤×¢×™×œ â†’ ××“×œ×’×™×

2. âœ… ××™×¤×•×¡ Daily PnL (×× ×™×•× ×—×“×©)

3. âœ… ×‘×“×™×§×ª ××’×‘×œ×•×ª ×¡×™×›×•×Ÿ
   - Daily Loss Limit
   - Max Drawdown
   
4. âœ… ×‘×“×™×§×ª ×–××Ÿ ×›× ×™×¡×”
   - ×× ××—×¨×™ latestEntryTime â†’ ××“×œ×’×™×

5. âœ… ×‘×“×™×§×ª ×¤×•×–×™×¦×™×” ×§×™×™××ª
   - ×× ×™×© ×›×‘×¨ ×¤×•×–×™×¦×™×” ×¢×œ ×”×× ×™×” â†’ ××“×œ×’×™×
```

### ×©×œ×‘ 3: ××™××•×ª × ×ª×•× ×™ ×”×›× ×™×¡×”

```
1. âœ… ×‘×“×™×§×ª entryPrice ×§×™×™× ×•×ª×§× ×™
2. âœ… ×‘×“×™×§×ª stopLoss ×§×™×™× ×•×ª×§× ×™
3. âœ… ×‘×“×™×§×ª ×”×ª×××ª ×›×™×•×•×Ÿ
   - Strategy Direction vs Master Direction
4. âœ… ×‘×“×™×§×ª Stop Loss ×‘×›×™×•×•×Ÿ ×”× ×›×•×Ÿ
   - LONG: stopLoss < entryPrice
   - SHORT: stopLoss > entryPrice
```

### ×©×œ×‘ 4: ×‘× ×™×™×ª TradeSetup

```
×—×™×©×•×‘ ×’×•×“×œ ×¤×•×–×™×¦×™×” ×œ×¤×™ R-Multiple:

1. ×—×™×©×•×‘ ×¡×™×›×•×Ÿ ×œ×™×—×™×“×”:
   riskPerShare = |entryPrice - stopLoss|

2. ×—×™×©×•×‘ ×ª×§×¦×™×‘ ×¡×™×›×•×Ÿ:
   riskBudget = totalAccountValue Ã— (riskPerTradePct / 100)

3. ×—×™×©×•×‘ ×›××•×ª:
   quantity = floor(riskBudget / riskPerShare)

4. ×”×’×‘×œ×” ×œ×¤×™ ×—×©×™×¤×”:
   maxNotionalPerTrade = (totalAccountValue Ã— maxExposurePct / 100) / maxConcurrentTrades
   if (quantity Ã— entryPrice > maxNotionalPerTrade):
     quantity = floor(maxNotionalPerTrade / entryPrice)

5. ×—×™×©×•×‘ ×¡×™×›×•×Ÿ ×“×•×œ×¨×™ ×¡×•×¤×™:
   riskDollars = quantity Ã— riskPerShare
```

### ×©×œ×‘ 5: ×‘×“×™×§×ª ××’×‘×œ×•×ª × ×•×¡×¤×•×ª

```
1. âœ… ×‘×“×™×§×ª ××¡×¤×¨ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª
   - ×× ××œ× â†’ × ×™×¡×™×•×Ÿ Opportunity Reallocation
   
2. âœ… ×‘×“×™×§×ª ×—×©×™×¤×” ×›×•×œ×œ×ª
   - ×× ×—×•×¨×’×ª â†’ ××“×œ×’×™×

3. âœ… ×‘×“×™×§×ª ×’×•×“×œ ×¤×•×–×™×¦×™×” ×œ×× ×™×”
   - ×× ×—×•×¨×’ â†’ ××“×œ×’×™×
```

### ×©×œ×‘ 6: ×‘×™×¦×•×¢ ×”×¤×§×•×“×”

```
×× mode === "LIVE":
  1. ×‘×“×™×§×ª ×—×™×‘×•×¨ IBKR
  2. ×™×¦×™×¨×ª OrderStatusInfo (PENDING)
  3. ×§×¨×™××” ×œ-ibkrClient.placeMarketOrder()
  4. ×¢×“×›×•×Ÿ ×¡×˜×˜×•×¡ ×¤×§×•×“×” (FILLED/REJECTED)
  
×× mode === "DEMO" ××• "BACKTEST":
  - × ×—×©×‘ Fill ××™×™×“×™ ×‘××—×™×¨ ×”×›× ×™×¡×”
```

### ×©×œ×‘ 7: ×¤×ª×™×—×ª ×¤×•×–×™×¦×™×”

```
×× ×‘×™×¦×•×¢ ×”×¦×œ×™×—:
  1. ×™×¦×™×¨×ª OpenPosition
  2. ×”×•×¡×¤×” ×œ-openPositions array
  3. ××™×¤×•×¡ consecutiveFailures counter

×× ×‘×™×¦×•×¢ × ×›×©×œ:
  1. ×¨×™×©×•× ×›×©×œ×•×Ÿ (circuit breaker)
  2. ×¢×“×›×•×Ÿ order status ×œ-REJECTED
```

### ×“×™××’×¨××ª ×–×¨×™××” ××œ××”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          PatternFoundEvent Received                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Pre-Flight Checks:             â”‚
        â”‚  1. Circuit Breaker?            â”‚
        â”‚  2. Daily PnL Reset?            â”‚
        â”‚  3. Risk Limits OK?             â”‚
        â”‚  4. Within Entry Time Window?   â”‚
        â”‚  5. No Existing Position?       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                                   â”‚
        â–¼ (All Checks Pass)                 â–¼ (Any Check Fails)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Validation:           â”‚         â”‚ Skip / Return         â”‚
â”‚ - entryPrice valid?   â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - stopLoss valid?     â”‚
â”‚ - Direction match?    â”‚
â”‚ - Stop in direction?  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Build TradeSetup:     â”‚
â”‚ - Calculate quantity  â”‚
â”‚ - Calculate risk$     â”‚
â”‚ - Apply limits        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Position Limits:      â”‚
â”‚ - Concurrent trades?  â”‚
â”‚   â†’ Try Reallocation  â”‚
â”‚ - Total exposure?     â”‚
â”‚ - Per-symbol limit?   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Execute Order:        â”‚
â”‚ - LIVE â†’ IBKR API     â”‚
â”‚ - DEMO â†’ Simulate     â”‚
â”‚ - BACKTEST â†’ Record   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚
        â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Create OpenPosition   â”‚
â”‚ Add to openPositions[]â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“Š × ×™×”×•×œ ×¤×•×–×™×¦×™×•×ª

### ×¢×“×›×•×Ÿ ××—×™×¨×™× ×‘×–××Ÿ ×××ª

**×ª×”×œ×™×š:**

```
×¢×œ ×›×œ ×¢×“×›×•×Ÿ ××—×™×¨:
  1. ×§×¨×™××” ×œ-onMarketPriceUpdate(symbol, lastPrice)
  2. ××¦×™××ª ×¤×•×–×™×¦×™×” ×¤×ª×•×—×” ×œ×× ×™×”
  3. ×¢×“×›×•×Ÿ lastPrice
  4. ×¢×“×›×•×Ÿ bestPrice (×”××—×™×¨ ×”×˜×•×‘ ×‘×™×•×ª×¨ ×©×”×•×©×’)
  5. ×¢×“×›×•×Ÿ Trailing Stop (×× ×¨×œ×•×•× ×˜×™)
  6. ×‘×“×™×§×ª Stop Loss Exit
```

**×§×•×“:**

```typescript
async onMarketPriceUpdate(symbol: string, lastPrice: number): Promise<void> {
  // Validate price
  if (!isFinite(lastPrice) || lastPrice <= 0) return;
  
  await this.withLock(async () => {
    const pos = this.findPositionBySymbol(symbol);
    if (!pos) return;
    
    pos.lastPrice = lastPrice;
    
    // Update best price
    if (pos.direction === "LONG") {
      pos.bestPrice = Math.max(pos.bestPrice, lastPrice);
    } else {
      pos.bestPrice = Math.min(pos.bestPrice, lastPrice);
    }
    
    // Update trailing stop
    this.updateTrailingStop(pos);
    
    // Check stop-loss
    this.checkStopLossExit(pos);
  });
}
```

### Trailing Stop Logic

**×ª×™××•×¨:**
- ×›×©×¤×•×–×™×¦×™×” ××’×™×¢×” ×œ-2R ×¨×•×•×—, ×”×¡×˜×•×¤ "× ×’×¨×¨" ××—×¨×™ ×”××—×™×¨
- ×”××¨×—×§: 1.5R ××”××—×™×¨ ×”×˜×•×‘ ×‘×™×•×ª×¨
- ×”×¡×˜×•×¤ ×¨×§ ××ª×§×“× ×‘×›×™×•×•×Ÿ ×”×¨×•×•×— (×œ× × ×¡×•×’ ××—×•×¨×”)

**×“×•×’××”:**

```
LONG Position:
  Entry: $100
  Initial Stop: $95 (5$ risk = 1R)
  Best Price: $110 (×”×’×™×¢ ×œ-2R ×¨×•×•×—)
  
  â†’ Trailing Stop ××ª×—×™×œ ×œ×¢×‘×•×“
  â†’ New Stop: $110 - (1.5 Ã— $5) = $102.50
  
  ×× ×”××—×™×¨ ×××©×™×š ×œ×¢×œ×•×ª:
    Best Price: $115
    â†’ New Stop: $115 - $7.50 = $107.50
    
  ×× ×”××—×™×¨ ×™×•×¨×“ ×œ×¡×˜×•×¤ â†’ ×¡×’×™×¨×” ×‘-$107.50
```

---

## âš ï¸ × ×™×”×•×œ ×¡×™×›×•× ×™×

### 1. R-Based Position Sizing

**××˜×¨×”:** ×œ×”×‘×˜×™×— ×©×›×œ ×¢×¡×§×” ××¡×›× ×ª ××—×•×– ×§×‘×•×¢ ××”×—×©×‘×•×Ÿ

**× ×•×¡×—×”:**

```
riskPerShare = |entryPrice - stopLoss|
riskBudget = totalAccountValue Ã— (riskPerTradePct / 100)
quantity = floor(riskBudget / riskPerShare)

×“×•×’××”:
  Account: $10,000
  Risk per Trade: 1%
  Risk Budget: $100
  
  Entry: $180.50
  Stop: $185.00
  Risk per Share: $4.50
  
  Quantity: floor($100 / $4.50) = 22 shares
  Actual Risk: 22 Ã— $4.50 = $99
```

### 2. Exposure Limits

**××’×‘×œ×•×ª ×—×©×™×¤×”:**

1. **Max Exposure Percentage**
   - ××—×•×– ××§×¡×™××œ×™ ××”×—×©×‘×•×Ÿ ×©×™×›×•×œ ×œ×”×™×•×ª ×—×©×•×£
   - ×“×•×’××”: 95% = $9,500 ××ª×•×š $10,000

2. **Max Concurrent Trades**
   - ××¡×¤×¨ ××§×¡×™××œ×™ ×©×œ ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª ×‘××§×‘×™×œ
   - ×“×•×’××”: 3 ×¢×¡×§××•×ª = ××§×¡×™××•× 3 ×¤×•×–×™×¦×™×•×ª

3. **Max Position Size Per Symbol**
   - ×’×•×“×œ ××§×¡×™××œ×™ ×œ×›×œ ×× ×™×”
   - ×“×•×’××”: $5,000 ×œ×× ×™×” ××—×ª

### 3. Daily Risk Limits

**××’×‘×œ×•×ª ×™×•××™×•×ª:**

1. **Daily Loss Limit**
   - ××’×‘×œ×ª ×”×¤×¡×“ ×™×•××™ ×‘×“×•×œ×¨×™×
   - ×× ×”×•×©×’×” â†’ ×›×œ ×”×¢×¡×§××•×ª × ×—×¡××•×ª

2. **Max Drawdown Percentage**
   - ××’×‘×œ×ª Drawdown ×××– ×”×©×™×
   - ×× ×”×•×©×’×” â†’ ×›×œ ×”×¢×¡×§××•×ª × ×—×¡××•×ª

**×—×™×©×•×‘ Drawdown:**

```
accountPeak = highest account value reached
currentValue = totalAccountValue + dailyPnL
drawdown = accountPeak - currentValue
drawdownPct = (drawdown / accountPeak) Ã— 100

×× drawdownPct >= maxDrawdownPct:
  â†’ Stop all trading
```

### 4. Time-Based Risk Management

**××’×‘×œ×•×ª ×–××Ÿ:**

1. **Latest Entry Time**
   - ×©×¢×” ××—×¨×•× ×” ×œ×›× ×™×¡×” ×œ×¢×¡×§×” ×—×“×©×”
   - ×“×•×’××”: 15:30 = ×œ× × ×›× ×¡×™× ××—×¨×™ 15:30

2. **Force Exit Time**
   - ×©×¢×” ×œ×¡×’×™×¨×” ×›×¤×•×™×” ×©×œ ×›×œ ×”×¤×•×–×™×¦×™×•×ª
   - ×“×•×’××”: 15:45 = ×›×œ ×”×¤×•×–×™×¦×™×•×ª × ×¡×’×¨×•×ª

**×¡×™×‘×•×ª:**
- ×”×™×× ×¢×•×ª ××¡×—×¨ ×‘×¡×•×£ ×™×•× (×¤×—×•×ª × ×–×™×œ×•×ª)
- × ×™×”×•×œ ×¡×™×›×•× ×™× ×œ×¤× ×™ ×¡×’×™×¨×ª ×©×•×§
- ×”×™×× ×¢×•×ª ××¢×¡×§××•×ª ×¤×ª×•×—×•×ª ×‘×™×Ÿ ×™××™×

---

## ğŸš€ ×ª×›×•× ×•×ª ××ª×§×“××•×ª

### 1. Opportunity Reallocation

**××˜×¨×”:** ×”×—×œ×¤×ª ×¤×•×–×™×¦×™×” ×¨×•×•×—×™×ª ×‘×¤×—×•×ª ××‘×˜×™×—×” ×‘×¤×•×–×™×¦×™×” ×—×“×©×” ×¢× ×¤×•×˜× ×¦×™××œ ×’×‘×•×” ×™×•×ª×¨

**×ª×”×œ×™×š:**

```
×›×©××’×™×¢ PatternFoundEvent ××‘×œ ×™×© ×›×‘×¨ maxConcurrentTrades ×¤×•×–×™×¦×™×•×ª:

1. ×—×™×¤×•×© ×¤×•×–×™×¦×™×” ×§×™×™××ª ×©×¢×•××“×ª ×‘×§×¨×™×˜×¨×™×•× ×™×:
   âœ… currentR >= relocationThresholdR (×œ××©×œ 2.0R)
   âœ… ×¤×•×–×™×¦×™×” ×¨×•×•×—×™×ª
   âœ… masterScore × ××•×š ×™×•×ª×¨ ××”×¤×•×–×™×¦×™×” ×”×—×“×©×”

2. ×× × ××¦××” ×¤×•×–×™×¦×™×” ××ª××™××”:
   - ×¡×’×™×¨×ª ×”×¤×•×–×™×¦×™×” ×”×™×©× ×” (exitReason: "relocation")
   - ×¤×ª×™×—×ª ×”×¤×•×–×™×¦×™×” ×”×—×“×©×”

3. ×× ×œ× × ××¦××”:
   - ×”×¤×•×–×™×¦×™×” ×”×—×“×©×” × ×“×—×™×ª
```

**×“×•×’××”:**

```
×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª (maxConcurrentTrades = 3):
  1. AAPL (masterScore: 6.5, currentR: 2.3R) âœ…
  2. GOOGL (masterScore: 7.2, currentR: 1.5R)
  3. MSFT (masterScore: 6.8, currentR: 0.8R)

PatternFoundEvent ×—×“×©:
  Symbol: TSLA
  masterScore: 8.5
  relocationThresholdR: 2.0

×ª×•×¦××”:
  - AAPL ×¢×•××“×ª ×‘×§×¨×™×˜×¨×™×•× ×™× (2.3R >= 2.0, ×¨×•×•×—×™×ª)
  - AAPL × ×¡×’×¨×ª (relocation)
  - TSLA × ×¤×ª×—×ª
```

### 2. Trailing Stop Management

**××˜×¨×”:** ×”×’× ×” ×¢×œ ×¨×•×•×—×™× ×ª×•×š ××¤×©×¨×•×ª ×œ×”××©×™×š ×œ×¨×•×•×—

**×œ×•×’×™×§×”:**

```typescript
// Trailing stop ××ª×—×™×œ ×œ×¢×‘×•×“ ×‘-2R ×¨×•×•×—
if (currentR >= 2.0) {
  const trailDistance = riskPerShare Ã— 1.5;  // 1.5R ××”××—×™×¨ ×”×˜×•×‘
  
  if (direction === "LONG") {
    newStop = bestPrice - trailDistance;
    // ×¨×§ ×œ×”×–×™×– ×œ××¢×œ×” (×”×§×˜× ×ª ×¡×™×›×•×Ÿ)
    if (newStop > currentStop && newStop < entryPrice) {
      stopLoss = newStop;
    }
  }
  // Similar for SHORT...
}
```

**×™×ª×¨×•× ×•×ª:**
- ×”×’× ×” ×¢×œ ×¨×•×•×—×™×
- ××¤×©×¨×•×ª ×œ×”××©×™×š ×œ×¨×•×•×—
- × ×™×”×•×œ ×¡×™×›×•×Ÿ ×“×™× ××™

### 3. Circuit Breaker System

**××˜×¨×”:** ×¢×¦×™×¨×” ××•×˜×•××˜×™×ª ×‘××§×¨×” ×©×œ ×›×©×œ×•× ×•×ª ×¨×¦×•×¤×™×

**×ª×”×œ×™×š:**

```
1. ××¢×§×‘ ××—×¨×™ consecutiveFailures

2. ×× consecutiveFailures >= threshold (×œ××©×œ 5):
   - ×”×¤×¢×œ×ª Circuit Breaker
   - ×¢×¦×™×¨×ª ×›×œ ×”×¢×¡×§××•×ª ×”×—×“×©×•×ª
   - ×”××ª× ×” ×œ-cooldownMs (×œ××©×œ 60 ×©× ×™×•×ª)

3. ××—×¨×™ Cooldown:
   - ××™×¤×•×¡ counter
   - ×”××©×š ×¤×¢×™×œ×•×ª × ×•×¨××œ×™×ª
```

**×©×™××•×©:**
- ×”×’× ×” ××¤× ×™ ×ª×§×œ×•×ª ×˜×›× ×™×•×ª
- ×× ×™×¢×ª ×‘×™×¦×•×¢ ×¢×¡×§××•×ª ×ª×§×•×œ×•×ª
- ×–××Ÿ ×œ×‘×“×™×§×” ×•×ª×™×§×•×Ÿ

### 4. Mode Support (LIVE/DEMO/BACKTEST)

**×”×‘×“×œ×™×:**

| Feature | LIVE | DEMO | BACKTEST |
|---------|------|------|----------|
| **Order Execution** | IBKR API | Simulated | Recorded only |
| **Fill Price** | Actual fill | Entry price | Entry price |
| **Real Money** | Yes | No | No |
| **Connection** | Required | Not required | Not required |
| **Use Case** | Production | Testing | Historical analysis |

**×”×—×œ×˜×”:**

```typescript
if (config.mode === "LIVE") {
  // Real IBKR API call
  const result = await ibkrClient.placeMarketOrder(...);
} else {
  // Simulate immediate fill at entry price
  return {
    avgFillPrice: setup.entryPrice,
    filledQuantity: setup.quantity
  };
}
```

---

## ğŸ”— ××™× ×˜×’×¨×¦×™×•×ª

### 1. ××™× ×˜×’×¨×¦×™×” ×¢× Trade Pattern Scanner

**×–×¨×™××ª × ×ª×•× ×™×:**

```
Trade Pattern Scanner
  â†“ (detects pattern)
PatternFoundEvent
  â†“
ExecutionEngine.onPatternEvent(event)
  â†“
Trade Setup & Execution
```

**×“×¨×™×©×•×ª ×-PatternFoundEvent:**

```typescript
event.patternState.entryPrice    // âœ… Required
event.patternState.stopLoss      // âœ… Required
event.master.masterScore         // âœ… For ranking
event.master.direction           // âœ… For direction validation
event.strategyDirection          // âœ… For direction matching
```

### 2. ××™× ×˜×’×¨×¦×™×” ×¢× IBKR Broker

**×“×¨×™×©×•×ª:**

1. **IBKRClient Implementation**
   - ×—×™×‘×•×¨ ×œ-IBKR TWS/Gateway
   - ×‘×™×¦×•×¢ ×¤×§×•×“×•×ª Market Order
   - × ×™×”×•×œ ×—×™×‘×•×¨ (reconnect)

2. **Order Management**
   - ××¢×§×‘ ××—×¨×™ ×¡×˜×˜×•×¡ ×¤×§×•×“×•×ª
   - ×˜×™×¤×•×œ ×‘-Partial Fills
   - ×˜×™×¤×•×œ ×‘×¤×§×•×“×•×ª × ×“×—×•×ª

**××™××•×©:**

```typescript
class IBKRClientImpl implements IBKRClient {
  async placeMarketOrder(
    symbol: string,
    quantity: number,
    side: "BUY" | "SELL"
  ): Promise<OrderExecutionResult> {
    // Connect to IBKR API
    // Place market order
    // Wait for fill
    // Return result
  }
}
```

### 3. ××™× ×˜×’×¨×¦×™×” ×¢× Convex (×©××™×¨×ª × ×ª×•× ×™×)

**× ×ª×•× ×™× ×œ×©××™×¨×”:**

1. **Open Positions** â†’ `activeTrades` table
2. **Closed Trades** â†’ `tradeHistory` table
3. **Order Status** â†’ (×¢×ª×™×“×™) `orders` table

**×¤×•×¨××˜ ×©××™×¨×”:**

```typescript
// Active Trade
{
  userId: string,
  strategyId: Id<"strategies">,
  strategyType: string,
  symbol: string,
  side: "long" | "short",
  quantity: number,
  entryPrice: number,
  currentPrice: number,
  entryTime: number,
  stopLoss: number,
  takeProfit: number,
  unrealizedPnL: number,
  unrealizedPnLPercent: number,
  status: "open" | "pending" | "closing",
  orderId?: string
}

// Trade History
{
  userId: string,
  strategyId: Id<"strategies">,
  strategyType: string,
  symbol: string,
  side: "long" | "short",
  quantity: number,
  entryPrice: number,
  exitPrice: number,
  entryTime: number,
  exitTime: number,
  realizedPnL: number,
  realizedPnLPercent: number,
  exitReason: string,
  commission?: number
}
```

---

## ğŸ“Š ××¦×‘ × ×•×›×—×™ ×•×ª×›× ×•×Ÿ ×¢×ª×™×“×™

### âœ… ××” ×›×‘×¨ ×§×™×™×

1. **ExecutionEngine Class**
   - âœ… ××¨×›×™×˜×§×˜×•×¨×” ××œ××”
   - âœ… Event handling (onPatternEvent)
   - âœ… Position management
   - âœ… R-based position sizing
   - âœ… Risk limits checking
   - âœ… Opportunity reallocation
   - âœ… Trailing stops
   - âœ… Circuit breaker
   - âœ… Time-based exits
   - âœ… Mode support (LIVE/DEMO/BACKTEST)

2. **Type Definitions**
   - âœ… ×›×œ ×”-interfaces ××•×’×“×¨×™×
   - âœ… Type safety ××œ×

3. **Validation Layers**
   - âœ… Input validation
   - âœ… Config validation
   - âœ… Price validation

4. **Thread Safety**
   - âœ… Lock mechanism (withLock)
   - âœ… Race condition prevention

5. **Performance Metrics**
   - âœ… getPerformanceMetrics()
   - âœ… getCurrentExposure()
   - âœ… getDailyPnL()
   - âœ… getCurrentDrawdownPct()

### ğŸš§ ××” ×—×¡×¨ (×˜×¨× ××™×•×©×)

1. **IBKR Client Implementation**
   - âŒ ×—×™×‘×•×¨ ×œ-IBKR ×˜×¨× ×§×™×™×
   - âŒ Order management ××œ×
   - âŒ Connection handling
   - âŒ Error recovery

2. **Convex Integration**
   - âŒ ×©××™×¨×ª ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª ×‘-Convex
   - âŒ ×©××™×¨×ª ×”×™×¡×˜×•×¨×™×™×ª ×¢×¡×§××•×ª
   - âŒ Real-time sync

3. **Strategy-Specific Exits**
   - âŒ ××™× ×˜×’×¨×¦×™×” ×¢× exitFirst() / exitSecond()
   - âŒ ×œ×•×’×™×§×ª ×™×¦×™××” ××•×ª×××ª ×œ××¡×˜×¨×˜×’×™×”

4. **Take Profit Management**
   - âŒ Take Profit targets
   - âŒ Partial exits
   - âŒ Target R management

5. **Order Status Tracking**
   - âŒ pendingOrders Map (×”×•×’×“×¨ ×‘×§×•×“ ××‘×œ ×œ× ×××•×ª×—×œ)
   - âŒ orderHistory array (×”×•×’×“×¨ ×‘×§×•×“ ××‘×œ ×œ× ×××•×ª×—×œ)
   - âŒ Order status updates

6. **Advanced Features**
   - âŒ Partial position closing
   - âŒ Dynamic position sizing
   - âŒ Portfolio correlation checks
   - âŒ Sector exposure limits

### ğŸ“… ×ª×›× ×•×Ÿ ×¢×ª×™×“×™

#### ×©×œ×‘ 1: ×—×™×‘×•×¨×™× ×‘×¡×™×¡×™×™×
- [ ] IBKRClient implementation
- [ ] Convex integration (save positions/trades)
- [ ] Order status tracking ××œ×

#### ×©×œ×‘ 2: ×ª×›×•× ×•×ª ×‘×™×¦×•×¢ ××ª×§×“××•×ª
- [ ] Strategy-specific exits
- [ ] Take Profit management
- [ ] Partial exits

#### ×©×œ×‘ 3: × ×™×”×•×œ ×¡×™×›×•× ×™× ××ª×§×“×
- [ ] Portfolio correlation analysis
- [ ] Sector exposure limits
- [ ] Dynamic position sizing

#### ×©×œ×‘ 4: × ×™×˜×•×¨ ×•×“×™×•×•×—
- [ ] Real-time dashboard
- [ ] Performance analytics
- [ ] Alert system

---

## ğŸ’¡ ×“×•×’×××•×ª ×©×™××•×©

### ×“×•×’××” 1: ××ª×—×•×œ ×‘×¡×™×¡×™

```typescript
import { ExecutionEngine } from "@/lib/execution/execution-engine";
import { IBKRClientImpl } from "@/lib/ibkr/client";

// ×™×¦×™×¨×ª IBKR Client (×× LIVE mode)
const ibkrClient = mode === "LIVE" ? new IBKRClientImpl({
  host: "127.0.0.1",
  port: 7497,
  accountId: "DU123456"
}) : null;

// ×™×¦×™×¨×ª Execution Engine
const executionEngine = new ExecutionEngine(
  {
    totalAccountValue: 10000,
    maxExposurePct: 95,
    maxConcurrentTrades: 3,
    riskPerTradePct: 1,
    mode: "DEMO",
    latestEntryTime: "15:30",
    forceExitTime: "15:45",
    relocationThresholdR: 2.0,
    dailyLossLimit: 500,
    maxDrawdownPct: 10,
    circuitBreakerEnabled: true,
    circuitBreakerFailureThreshold: 5,
    circuitBreakerCooldownMs: 60000
  },
  ibkrClient,
  strategyMap  // Map<string, IPatternStrategy>
);

// ×—×™×‘×•×¨ ×œ×¡×•×¨×§
scanner.onPatternFound = (event) => {
  executionEngine.onPatternEvent(event);
};

// ×¢×“×›×•×Ÿ ××—×™×¨×™×
dataClient.subscribePriceUpdates((symbol, price) => {
  executionEngine.onMarketPriceUpdate(symbol, price);
});
```

### ×“×•×’××” 2: ×¡×’×™×¨×” ×›×¤×•×™×” ×‘×¡×•×£ ×”×™×•×

```typescript
// ×§×¨×™××” ×›×œ ×“×§×” (×××•×¨×§×¡×˜×¨×˜×•×¨)
setInterval(async () => {
  const currentPrices: Record<string, number> = {
    "AAPL": 180.50,
    "GOOGL": 150.25,
    // ... ××›×œ ×”×¤×•×–×™×¦×™×•×ª ×”×¤×ª×•×—×•×ª
  };
  
  await executionEngine.forceExitAllIfTime(currentPrices);
}, 60_000); // ×›×œ ×“×§×”
```

### ×“×•×’××” 3: ×©×œ×™×¤×ª ××˜×¨×™×§×•×ª ×‘×™×¦×•×¢×™×

```typescript
// ×©×œ×™×¤×ª ×¤×•×–×™×¦×™×•×ª ×¤×ª×•×—×•×ª
const openPositions = executionEngine.getOpenPositions();
console.log(`Open positions: ${openPositions.length}`);

// ×©×œ×™×¤×ª ×¢×¡×§××•×ª ×¡×’×•×¨×•×ª
const closedTrades = executionEngine.getClosedTrades();
console.log(`Total trades: ${closedTrades.length}`);

// ××˜×¨×™×§×•×ª ×‘×™×¦×•×¢×™×
const metrics = executionEngine.getPerformanceMetrics();
console.log({
  winRate: `${metrics.winRate.toFixed(2)}%`,
  totalPnL: `$${metrics.totalPnL.toFixed(2)}`,
  averageR: metrics.averageR.toFixed(2),
  largestWin: `$${metrics.largestWin.toFixed(2)}`,
  largestLoss: `$${metrics.largestLoss.toFixed(2)}`
});

// ××¦×‘ ×—×©×‘×•×Ÿ
const exposure = executionEngine.getCurrentExposure();
const exposurePct = executionEngine.getCurrentExposurePct();
const accountValue = executionEngine.getCurrentAccountValue();
const drawdown = executionEngine.getCurrentDrawdownPct();
const dailyPnL = executionEngine.getDailyPnL();

console.log({
  accountValue: `$${accountValue.toFixed(2)}`,
  exposure: `$${exposure.toFixed(2)} (${exposurePct.toFixed(1)}%)`,
  dailyPnL: `$${dailyPnL.toFixed(2)}`,
  drawdown: `${drawdown.toFixed(2)}%`
});
```

### ×“×•×’××” 4: × ×™×˜×•×¨ Circuit Breaker

```typescript
// ×‘×“×™×§×” ×× Circuit Breaker ×¤×¢×™×œ
if (executionEngine.isCircuitBreakerOpen()) {
  console.warn("âš ï¸ Circuit Breaker is OPEN - Trading stopped");
  console.log("Please check system status and errors");
  
  // ××¤×©×¨ ×œ× ×¡×•×ª ××™×¤×•×¡ ×™×“× ×™ (×× ×™×© method)
  // executionEngine.resetCircuitBreaker();
}
```

---

## ğŸ“ˆ ××“×“×™ ×‘×™×¦×•×¢×™×

### ××˜×¨×™×§×•×ª ×—×©×•×‘×•×ª

1. **Execution Metrics**
   - ×–××Ÿ ××›× ×™×¡×” ×¢×“ Fill
   - Slippage (×”×¤×¨×© ×‘×™×Ÿ ××—×™×¨ ×¦×¤×•×™ ×œ××—×™×¨ ×‘×¤×•×¢×œ)
   - Fill rate (××—×•×– ×¤×§×•×“×•×ª ×©××ª×‘×¦×¢×•×ª)

2. **Performance Metrics**
   - Win Rate (% ×¢×¡×§××•×ª ×¨×•×•×—×™×•×ª)
   - Average R Multiple
   - Total P&L
   - Largest Win/Loss

3. **Risk Metrics**
   - Current Exposure (%)
   - Daily P&L
   - Drawdown (%)
   - Risk per Trade (actual vs target)

4. **Efficiency Metrics**
   - Opportunity Reallocation Rate
   - Trailing Stop Activation Rate
   - Circuit Breaker Triggers

---

## ğŸ”’ ××‘×˜×—×” ×•×™×¦×™×‘×•×ª

### ×× ×’× ×•× ×™ ×”×’× ×”

1. **Input Validation**
   - ××™××•×ª ×›×œ ×”× ×ª×•× ×™× ×”× ×›× ×¡×™×
   - ×‘×“×™×§×ª ××—×™×¨×™× ×ª×§×™× ×™× (×œ× NaN, Infinity, ×©×œ×™×œ×™×™×)
   - ×‘×“×™×§×ª ×›××•×™×•×ª ×ª×§×™× ×•×ª

2. **Config Validation**
   - ××™××•×ª configuration ×‘-constructor
   - ×‘×“×™×§×ª ×˜×•×•×—×™× ×ª×§×™× ×™×
   - ×‘×“×™×§×ª ×¢×¨×›×™× ×—×¡×¨×™×

3. **Thread Safety**
   - Lock mechanism ×œ×× ×™×¢×ª race conditions
   - Safe array modifications
   - Atomic position updates

4. **Error Handling**
   - Try-catch ×‘×›×œ ×”×¨××•×ª
   - Graceful failures
   - Logging ××¤×•×¨×˜

5. **Risk Limits**
   - Multiple layers of risk checks
   - Circuit breaker protection
   - Automatic stop mechanisms

---

## ğŸ” ×“×™××’×¨××ª ×–×¨×™××” ××œ××” - ××›× ×™×¡×” ×¢×“ ×™×¦×™××”

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          PatternFoundEvent Received                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Pre-Flight Checks              â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
   [Circuit    [Time        [Existing
    Breaker]    Window]      Position?]
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚ (All Pass)
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Build TradeSetup               â”‚
        â”‚  (Position Sizing by R)         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Check Limits:                  â”‚
        â”‚  - Concurrent Trades?           â”‚
        â”‚    â†’ Try Reallocation           â”‚
        â”‚  - Total Exposure?              â”‚
        â”‚  - Per-Symbol Limit?            â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Execute Order                  â”‚
        â”‚  (LIVE/DEMO/BACKTEST)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Create OpenPosition            â”‚
        â”‚  Add to openPositions[]         â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Real-Time Price Updates        â”‚
        â”‚  (onMarketPriceUpdate)          â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                 â”‚                 â”‚
        â–¼                 â–¼                 â–¼
  [Update       [Update        [Check
   lastPrice]    bestPrice]     Stop Loss]
        â”‚                 â”‚                 â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Update Trailing Stop           â”‚
        â”‚  (if currentR >= 2.0)           â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Exit Conditions:               â”‚
        â”‚  1. Stop Loss Hit?              â”‚
        â”‚  2. Force Exit Time?            â”‚
        â”‚  3. Strategy Exit? (future)     â”‚
        â”‚  4. Take Profit? (future)       â”‚
        â”‚  5. Manual?                     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚  Close Position                 â”‚
        â”‚  - Calculate P&L                â”‚
        â”‚  - Calculate R Multiple         â”‚
        â”‚  - Update dailyPnL              â”‚
        â”‚  - Move to closedTrades[]       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“š ××¡××›×™ ×¢×–×¨ × ×•×¡×¤×™×

- `docs/TRADE_PATTERN_SCANNER_COMPLETE_DOCUMENTATION.md` - ×ª×™×¢×•×“ ××¢×¨×›×ª ×”×¡×¨×™×§×”
- `docs/TRADE_ROUTER_COMPLETE_DOCUMENTATION.md` - ×ª×™×¢×•×“ ×›×•×œ×œ ×©×œ Trade Router
- `lib/execution/execution-engine.ts` - ×§×•×“ ×”××§×•×¨
- `convex/schema.ts` - ××‘× ×” ××¡×“ ×”× ×ª×•× ×™×

---

## ğŸ”§ ×”×¢×¨×•×ª ×˜×›× ×™×•×ª ×—×©×•×‘×•×ª

### 1. Order Status Tracking

**×¡×˜×˜×•×¡:** ×—×œ×§×™ - ×”×•×’×“×¨ ×‘×§×•×“ ××‘×œ ×œ× ×××•×ª×—×œ

```typescript
// ×‘×§×•×“ ×§×™×™× reference ×œ:
this.pendingOrders.set(...)
this.orderHistory.push(...)

// ××‘×œ ×œ× ×”×•×’×“×¨×• ×‘-constructor:
private pendingOrders: Map<string, OrderStatusInfo> = new Map();
private orderHistory: OrderStatusInfo[] = [];
```

**×¦×¨×™×š ×œ×”×•×¡×™×£:**
```typescript
export class ExecutionEngine {
  private pendingOrders: Map<string, OrderStatusInfo> = new Map();
  private orderHistory: OrderStatusInfo[] = [];
  // ... rest of the class
}
```

### 2. IBKRClient Interface Extension

**× ×™×ª×Ÿ ×œ×”×¨×—×™×‘:**

```typescript
export interface IBKRClient {
  placeMarketOrder(...): Promise<OrderExecutionResult>;
  
  // Optional but recommended:
  isConnected?(): boolean;
  reconnect?(): Promise<void>;
  cancelOrder?(orderId: string): Promise<void>;
  getOrderStatus?(orderId: string): Promise<OrderStatusInfo>;
}
```

### 3. Strategy-Specific Exits

**×ª×›× ×•×Ÿ ×¢×ª×™×“×™:**

```typescript
// ×‘××¡×˜×¨×˜×’×™×•×ª (future):
export interface IPatternStrategy {
  // ... existing methods
  
  evaluateExit?(
    candles: Candle[],
    indicators: IndicatorSnapshot,
    position: OpenPosition
  ): ExitSignal | null;
}

// ×‘-Execution Engine:
async onMarketPriceUpdateWithCandles(...) {
  const strategy = this.strategyMap.get(pos.strategyName);
  if (strategy?.evaluateExit) {
    const exitSignal = strategy.evaluateExit(candles, indicators, pos);
    if (exitSignal?.exit) {
      this.closePosition(pos, exitSignal.price, "strategy-exit");
    }
  }
}
```

---

## ğŸ“Š ×˜×‘×œ×ª ×¡×™×›×•× - ××¦×‘ ×ª×›×•× ×•×ª

| ×ª×›×•× ×” | ×¡×˜×˜×•×¡ | ×”×¢×¨×•×ª |
|------|-------|-------|
| Event Handling | âœ… | onPatternEvent ××œ× |
| Position Sizing (R-based) | âœ… | ××œ× ×•×¤×•×¢×œ |
| Risk Limits | âœ… | Daily loss, drawdown, exposure |
| Opportunity Reallocation | âœ… | ××œ× ×•×¤×•×¢×œ |
| Trailing Stops | âœ… | ××ª×—×™×œ ×‘-2R |
| Circuit Breaker | âœ… | ××œ× ×•×¤×•×¢×œ |
| Time-based Exits | âœ… | Force exit ×‘×¡×•×£ ×™×•× |
| Mode Support | âœ… | LIVE/DEMO/BACKTEST |
| IBKR Integration | ğŸš§ | Interface ××•×’×“×¨, implementation ×—×¡×¨ |
| Convex Integration | ğŸš§ | Schema ×§×™×™×, save/load ×—×¡×¨ |
| Strategy Exits | ğŸš§ | Placeholder ×§×™×™× |
| Take Profit | âŒ | ×˜×¨× ××™×•×©× |
| Partial Exits | âŒ | ×˜×¨× ××™×•×©× |
| Order Tracking | ğŸš§ | Type definitions ×§×™×™××™×, initialization ×—×¡×¨ |

---

**×¡×•×£ ×”×“×•×—**

